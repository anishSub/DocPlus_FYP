{% extends 'base/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'find_doctor/css/doctor_registration.css' %}">
{% endblock %}

{% block content %}
<div class="registration-wrapper">
    
    <div class="registration-header">
        <div class="container">
            <a href="/" class="back-link"><i class="fas fa-chevron-left"></i> Back to Home</a>
            <div class="header-content">
                <div>
                    <h1>Doctor Registration</h1>
                    <p>Join DocPlus and help patients across Nepal</p>
                </div>
                <div class="shield-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-container">
        
        <div class="stepper-wrapper">
            <div class="step-indicator">
                <div class="step active" id="step-indicator-0">
                    <div class="circle"><i class="far fa-user"></i></div>
                    <div class="label">Personal</div>
                </div>
                <div class="line"></div>
                <div class="step" id="step-indicator-1">
                    <div class="circle"><i class="fas fa-stethoscope"></i></div>
                    <div class="label">Professional</div>
                </div>
                <div class="line"></div>
                <div class="step" id="step-indicator-2">
                    <div class="circle"><i class="fas fa-graduation-cap"></i></div>
                    <div class="label">Education</div>
                </div>
                <div class="line"></div>
                <div class="step" id="step-indicator-3">
                    <div class="circle"><i class="far fa-file-alt"></i></div>
                    <div class="label">Documents</div>
                </div>
                <div class="line"></div>
                <div class="step" id="step-indicator-4">
                    <div class="circle"><i class="far fa-check-circle"></i></div>
                    <div class="label">Review</div>
                </div>
            </div>
        </div>

        <form id="regForm" action="{% url 'doctor_registration' %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-step active" id="step-0">
                <h2 class="step-title">Personal Information</h2>
                <p class="step-desc">Please provide your basic personal details</p>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" name="full_name" id="full_name" placeholder="Full Name" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" name="email" id="email" placeholder="@example.com" required>
                        <small id="emailError" style="color: red; display: none;"></small>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <div class="password-container">
                            <input type="password" name="password" id="password" required>
                            <i class="fas fa-eye toggle-eye" onclick="togglePassword('password', this)"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password *</label>
                        <div class="password-container">
                            <input type="password" name="password2" id="password2" required>
                            <i class="fas fa-eye toggle-eye" onclick="togglePassword('password2', this)"></i>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Phone *</label>
                        <input type="tel" name="phone" id="phone" placeholder="+977" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" name="dob" id="dob" required max="{% now 'Y-m-d' %}">
                    </div>
                    <div class="form-group">
                        <label>Gender *</label>
                        <select name="gender" id="gender" required>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" name="city" id="city" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Full Address *</label>
                        <input type="text" name="address" id="address" required>
                    </div>
                </div>
            </div>

            <div class="form-step" id="step-1">
                <h2 class="step-title">Professional Information</h2>
                <p class="step-desc">Your medical credentials</p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Specialty *</label>
                        <select name="specialty" id="specialty" required onchange="toggleSpecialty(this)">
                            <option value="">Select Specialty</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Neurology">Neurology</option>
                            <option value="Orthopedics">Orthopedics</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="specialty_other" placeholder="Specify..." style="display: none; margin-top: 10px;">
                    </div>
                    <div class="form-group">
                        <label>Sub-Specialty</label>
                        <input type="text" name="sub_specialty" id="sub_specialty">
                    </div>
                    <div class="form-group">
                        <label>License No *</label>
                        <input type="text" name="license_no" id="license_no" required>
                    </div>
                    <div class="form-group">
                        <label>Registration No *</label>
                        <input type="text" name="reg_no" id="reg_no" required>
                    </div>
                    <div class="form-group">
                        <label>Council *</label>
                        <input type="text" name="council" id="council" value="Nepal Medical Council" required>
                    </div>
                    <div class="form-group">
                        <label>Experience (Years) *</label>
                        <input type="number" name="experience" id="experience" required>
                    </div>

                    <div class="form-group full-width">
                        <label style="margin-bottom: 10px; display:block; font-weight:600;">Available Days *</label>
                        <div class="days-checkbox-grid" style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Mon"> Mon</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Tue"> Tue</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Wed"> Wed</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Thu"> Thu</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Fri"> Fri</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Sat"> Sat</label>
                            <label class="checkbox-label"><input type="checkbox" name="available_days" value="Sun"> Sun</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Start Time *</label>
                        <input type="time" name="available_time_start" id="available_time_start" required>
                    </div>
                    <div class="form-group">
                        <label>End Time *</label>
                        <input type="time" name="available_time_end" id="available_time_end" required>
                    </div>

                    <div class="form-group full-width">
                        <label>Languages</label>
                        <input type="text" name="languages" id="languages">
                    </div>
                </div>
            </div>

            <div class="form-step" id="step-2">
                <h2 class="step-title">Education</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Medical Degree *</label>
                        <input type="text" name="degree" id="degree" required>
                    </div>
                    <div class="form-group">
                        <label>University *</label>
                        <input type="text" name="university" id="university" required>
                    </div>
                    <div class="form-group">
                        <label>Grad Year *</label>
                        <input type="number" name="grad_year" id="grad_year" required>
                    </div>
                    <div class="form-group">
                        <label>Fee (NPR) *</label>
                        <input type="number" name="fee" id="fee" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Bio</label>
                        <textarea name="bio" id="bio" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="form-step" id="step-3">
                <h2 class="step-title">Upload Documents</h2>
                <div class="info-alert">
                    <i class="fas fa-info-circle"></i>
                    <div>Accepted formats: PDF, JPG, PNG (Max 5MB).</div>
                </div>

                <div class="upload-list">
                    <div class="upload-item">
                        <div class="icon-sq blue"><i class="far fa-file-alt"></i></div>
                        <div class="upload-info">
                            <label>CV / Resume *</label>
                            <span>Upload detailed CV</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="cv" id="cv" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('cv').click()">Upload</button>
                            <span class="file-name"></span>
                        </div>
                    </div>

                    <div class="upload-item">
                        <div class="icon-sq"><i class="fas fa-user-md"></i></div>
                        <div class="upload-info">
                            <label>Profile Photo</label>
                            <span>Professional photo</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="profile_photo" id="profile_photo" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('profile_photo').click()">Upload</button>
                            <span class="file-name"></span>
                        </div>
                    </div>

                    <div class="upload-item">
                        <div class="icon-sq"><i class="fas fa-shield-alt"></i></div>
                        <div class="upload-info">
                            <label>Medical License *</label>
                            <span>Valid license copy</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="license_doc" id="license_doc" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('license_doc').click()">Upload</button>
                            <span class="file-name"></span>
                        </div>
                    </div>

                    <div class="upload-item">
                        <div class="icon-sq green"><i class="fas fa-graduation-cap"></i></div>
                        <div class="upload-info">
                            <label>Degree Certificate *</label>
                            <span>Highest degree copy</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="degree_doc" id="degree_doc" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('degree_doc').click()">Upload</button>
                            <span class="file-name"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-step" id="step-4">
                <h2 class="step-title">Review Application</h2>

                <div class="review-block">
                    <h3 class="review-heading"><i class="far fa-user"></i> Personal Info</h3>
                    <div class="review-grid">
                        <div><label>Name</label><p id="rev_name">-</p></div>
                        <div><label>Email</label><p id="rev_email">-</p></div>
                        <div><label>Phone</label><p id="rev_phone">-</p></div>
                    </div>
                </div>

                <div class="review-block">
                    <h3 class="review-heading"><i class="fas fa-stethoscope"></i> Professional Info</h3>
                    <div class="review-grid">
                        <div><label>Specialty</label><p id="rev_specialty">-</p></div>
                        <div><label>License</label><p id="rev_license">-</p></div>
                        <div><label>Available Days</label><p id="rev_days">-</p></div>
                        <div><label>Timing</label><p id="rev_time">-</p></div>
                        
                        <div class="full-width" style="margin-top:10px">
                            <label>Hospital Affiliation</label>
                            <div class="form-group">
                                {{ form.hospital_affiliation }}
                            </div>
                            <div style="text-align:center; margin:10px; color:#888">- OR -</div>
                            <input type="text" name="hospital_name_manual" id="hospital_name_manual" placeholder="Type Hospital Name">
                            <p id="rev_hospital" style="display:none"></p>
                        </div>
                    </div>
                </div>

                <div class="terms-box">
                    <h3 class="terms-title">Terms & Conditions</h3>
                    <p class="terms-text">I certify that all information provided is accurate and true.</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" id="prevBtn" class="btn btn-secondary" onclick="nextPrev(-1)">Previous</button>
                <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextPrev(1)">Next</button>
            </div>

        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var currentTab = 0; 
    showTab(currentTab); 

    function showTab(n) {
        var x = document.getElementsByClassName("form-step");
        for(let i=0; i<x.length; i++) { x[i].style.display = "none"; x[i].classList.remove('active'); }
        x[n].style.display = "block";
        setTimeout(() => x[n].classList.add('active'), 10);

        let prevBtn = document.getElementById("prevBtn");
        prevBtn.style.display = "inline-flex";
        prevBtn.innerHTML = (n==0) ? "Cancel" : "Previous";
        if(n==0) prevBtn.onclick = function() { window.location.href="/"; };
        else prevBtn.onclick = function() { nextPrev(-1); };

        let nextBtn = document.getElementById("nextBtn");
        nextBtn.innerHTML = (n == x.length - 1) ? "Submit Application" : "Next";

        updateStepper(n);
        if(n == 4) populateReview();
    }

    function nextPrev(n) {
        var x = document.getElementsByClassName("form-step");
        if (n == 1 && !validateForm()) return false;
        
        // --- EMAIL CHECK LOGIC (SIMPLIFIED FOR BREVITY) ---
        if (currentTab == 0 && n == 1) {
            let emailInput = document.getElementById('email');
            if (!emailInput.checkValidity()) {
                emailInput.classList.add("invalid");
                return false;
            }
            // Add your fetch logic here from previous code if needed
        }

        currentTab = currentTab + n;
        if (currentTab >= x.length) {
            document.getElementById("regForm").submit();
            return false;
        }
        showTab(currentTab);
    }

    function validateForm() {
        var x = document.getElementsByClassName("form-step");
        var inputs = x[currentTab].querySelectorAll("input, select");
        var valid = true;
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].hasAttribute('required') && inputs[i].value == "") {
                inputs[i].classList.add("invalid");
                valid = false;
            }
        }
        return valid;
    }

    function updateStepper(n) {
        var steps = document.getElementsByClassName("step");
        var lines = document.getElementsByClassName("line");
        const icons = ['<i class="far fa-user"></i>', '<i class="fas fa-stethoscope"></i>', '<i class="fas fa-graduation-cap"></i>', '<i class="far fa-file-alt"></i>', '<i class="far fa-check-circle"></i>'];
        
        for (var i = 0; i < steps.length; i++) {
            steps[i].classList.remove("active", "completed");
            let circle = steps[i].querySelector('.circle');
            circle.innerHTML = icons[i];
            if(i < lines.length) lines[i].classList.remove("completed");

            if (i == n) steps[i].classList.add("active");
            else if (i < n) {
                steps[i].classList.add("completed");
                circle.innerHTML = '<i class="fas fa-check"></i>';
                if(i < lines.length) lines[i].classList.add("completed");
            }
        }
    }

    function updateFileName(input) {
        if(input.files && input.files[0]) {
            input.parentElement.querySelector('.file-name').innerText = input.files[0].name;
            let btn = input.parentElement.querySelector('.btn-upload');
            btn.innerHTML = 'Selected'; btn.style.background = '#10B981'; btn.style.color = 'white';
        }
    }

    function populateReview() {
        document.getElementById('rev_name').innerText = document.getElementById('full_name').value || '-';
        document.getElementById('rev_email').innerText = document.getElementById('email').value || '-';
        document.getElementById('rev_phone').innerText = document.getElementById('phone').value || '-';
        document.getElementById('rev_specialty').innerText = document.getElementById('specialty').value || '-';
        document.getElementById('rev_license').innerText = document.getElementById('license_no').value || '-';

        let checkboxes = document.querySelectorAll('input[name="available_days"]:checked');
        let days = []; checkboxes.forEach((c) => days.push(c.value));
        document.getElementById('rev_days').innerText = days.join(", ");
        
        let s = document.getElementById('available_time_start').value;
        let e = document.getElementById('available_time_end').value;
        document.getElementById('rev_time').innerText = `${s} - ${e}`;
    }

    function toggleSpecialty(selectObj) {
        var other = document.getElementById('specialty_other');
        other.style.display = (selectObj.value === 'Other') ? 'block' : 'none';
    }
    
    function togglePassword(id, icon) {
        var x = document.getElementById(id);
        if(x.type === "password") { x.type="text"; icon.classList.replace("fa-eye", "fa-eye-slash"); }
        else { x.type="password"; icon.classList.replace("fa-eye-slash", "fa-eye"); }
    }
</script>
{% endblock %}