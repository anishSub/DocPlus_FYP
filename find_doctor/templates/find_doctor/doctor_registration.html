{% extends 'base/base.html' %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/find_doctor/doctor_registration.css' %}">
{% endblock %}

{% block content %}
<div class="registration-wrapper">
    
    <!-- 1. HEADER SECTION -->
    <div class="registration-header">
        <div class="container">
            <a href="/" class="back-link"><i class="fas fa-chevron-left"></i> Back to Home</a>
            <div class="header-content">
                <div>
                    <h1>Doctor Registration</h1>
                    <p>Join DocPlus and help patients across Nepal</p>
                </div>
                <div class="shield-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. MAIN CARD -->
    <div class="container main-container">
        
        <!-- STEPPER -->
        <div class="stepper-wrapper">
            <div class="step-indicator">
                <div class="step active" id="step-indicator-0">
                    <div class="circle"><i class="far fa-user"></i></div>
                    <div class="label">Personal Info</div>
                </div>
                <div class="line"></div>
                
                <div class="step" id="step-indicator-1">
                    <div class="circle"><i class="fas fa-stethoscope"></i></div>
                    <div class="label">Professional</div>
                </div>
                <div class="line"></div>

                <div class="step" id="step-indicator-2">
                    <div class="circle"><i class="fas fa-graduation-cap"></i></div>
                    <div class="label">Education</div>
                </div>
                <div class="line"></div>

                <div class="step" id="step-indicator-3">
                    <div class="circle"><i class="far fa-file-alt"></i></div>
                    <div class="label">Documents</div>
                </div>
                <div class="line"></div>

                <div class="step" id="step-indicator-4">
                    <div class="circle"><i class="far fa-check-circle"></i></div>
                    <div class="label">Review</div>
                </div>
            </div>
        </div>

        <!-- FORM CONTAINER -->
        <form id="regForm" action="" method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- STEP 1: PERSONAL INFO -->
            <div class="form-step active" id="step-0">
                <h2 class="step-title">Personal Information</h2>
                <p class="step-desc">Please provide your basic personal details</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" name="full_name" id="full_name" placeholder="Anish Subedi" required>
                    </div>
                    <div class="form-group">
                        <label>Email Address *</label>
                        <input type="email" name="email" id="email" placeholder="subedianish937@gmail.com" required>
                    </div>
                    <div class="form-group">
                        <label>Phone Number *</label>
                        <input type="tel" name="phone" id="phone" placeholder="+977 9861067059" required>
                    </div>
                    <div class="form-group">
                        <label>Date of Birth *</label>
                        <input type="date" name="dob" id="dob" required>
                    </div>
                    <div class="form-group">
                        <label>Gender *</label>
                        <select name="gender" id="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>City *</label>
                        <input type="text" name="city" id="city" placeholder="Pokhara" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Full Address *</label>
                        <input type="text" name="address" id="address" placeholder="Enter your complete address" required>
                    </div>
                </div>
            </div>

            <!-- STEP 2: PROFESSIONAL INFO -->
            <div class="form-step" id="step-1">
                <h2 class="step-title">Professional Information</h2>
                <p class="step-desc">Your medical credentials and experience</p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Primary Specialty *</label>
                        <select name="specialty" id="specialty" required>
                            <option value="">Select Specialty</option>
                            <option value="Cardiology">Cardiology</option>
                            <option value="Neurology">Neurology</option>
                            <option value="General Medicine">General Medicine</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sub-Specialty</label>
                        <input type="text" name="sub_specialty" id="sub_specialty">
                    </div>
                    <div class="form-group">
                        <label>Medical License Number *</label>
                        <input type="text" name="license_no" id="license_no" required>
                    </div>
                    <div class="form-group">
                        <label>Registration Number *</label>
                        <input type="text" name="reg_no" id="reg_no" required>
                    </div>
                    <div class="form-group">
                        <label>Registration Council *</label>
                        <input type="text" name="council" id="council" value="Nepal Medical Council" required>
                    </div>
                    <div class="form-group">
                        <label>Years of Experience *</label>
                        <input type="number" name="experience" id="experience" placeholder="e.g. 5" required>
                    </div>
                    <div class="form-group">
                        <label>Current Hospital/Clinic *</label>
                        <input type="text" name="hospital" id="hospital" required>
                    </div>
                    <div class="form-group">
                        <label>Current Position</label>
                        <input type="text" name="position" id="position">
                    </div>
                    <div class="form-group full-width">
                        <label>Languages Spoken</label>
                        <input type="text" name="languages" id="languages" placeholder="English, Nepali, Hindi">
                    </div>
                </div>
            </div>

            <!-- STEP 3: EDUCATION -->
            <div class="form-step" id="step-2">
                <h2 class="step-title">Education & Qualifications</h2>
                <p class="step-desc">Your academic background and certifications</p>

                <div class="form-grid">
                    <div class="form-group">
                        <label>Medical Degree *</label>
                        <input type="text" name="degree" id="degree" placeholder="MBBS, MD" required>
                    </div>
                    <div class="form-group">
                        <label>Medical School/University *</label>
                        <input type="text" name="university" id="university" required>
                    </div>
                    <div class="form-group">
                        <label>Graduation Year *</label>
                        <input type="number" name="grad_year" id="grad_year" required>
                    </div>
                    <div class="form-group">
                        <label>Consultation Fee (NPR) *</label>
                        <input type="number" name="fee" id="fee" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Professional Bio</label>
                        <textarea name="bio" id="bio" rows="3" placeholder="Write a brief professional biography..."></textarea>
                    </div>
                </div>
            </div>

            <!-- STEP 4: DOCUMENTS -->
            <div class="form-step" id="step-3">
                <h2 class="step-title">Upload Documents</h2>
                <p class="step-desc">Please upload the required documents for verification</p>

                <div class="info-alert">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <strong>Important Information</strong><br>
                        All documents must be clear and legible. Accepted formats: PDF, JPG, PNG (Max 5MB).
                    </div>
                </div>

                <div class="upload-list">
                    <div class="upload-item">
                        <div class="icon-sq blue"><i class="far fa-file-alt"></i></div>
                        <div class="upload-info">
                            <label>Curriculum Vitae (CV) *</label>
                            <span>Upload your detailed CV/Resume</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="cv" id="cv" class="file-input" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('cv').click()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <span class="file-name"></span>
                        </div>
                    </div>

                    <div class="upload-item">
                        <div class="icon-sq"><i class="fas fa-shield-alt"></i></div>
                        <div class="upload-info">
                            <label>Medical License *</label>
                            <span>Upload your valid medical license</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="license_doc" id="license_doc" class="file-input" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('license_doc').click()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <span class="file-name"></span>
                        </div>
                    </div>

                    <div class="upload-item">
                        <div class="icon-sq green"><i class="fas fa-graduation-cap"></i></div>
                        <div class="upload-info">
                            <label>Medical Degree Certificate *</label>
                            <span>Upload your degree/education certificate</span>
                        </div>
                        <div class="upload-action">
                            <input type="file" name="degree_doc" id="degree_doc" class="file-input" hidden onchange="updateFileName(this)">
                            <button type="button" class="btn-upload" onclick="document.getElementById('degree_doc').click()">
                                <i class="fas fa-upload"></i> Upload
                            </button>
                            <span class="file-name"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STEP 5: REVIEW -->
            <div class="form-step" id="step-4">
                <h2 class="step-title">Review Your Application</h2>
                <p class="step-desc">Please review all information before submitting</p>

                <!-- Review Section: Personal -->
                <div class="review-block">
                    <h3 class="review-heading"><i class="far fa-user"></i> Personal Information</h3>
                    <div class="review-grid">
                        <div><label>Full Name</label><p id="rev_name">-</p></div>
                        <div><label>Email</label><p id="rev_email">-</p></div>
                        <div><label>Phone</label><p id="rev_phone">-</p></div>
                        <div><label>City</label><p id="rev_city">-</p></div>
                    </div>
                </div>

                <!-- Review Section: Professional -->
                <div class="review-block">
                    <h3 class="review-heading"><i class="fas fa-stethoscope"></i> Professional Information</h3>
                    <div class="review-grid">
                        <div><label>Specialty</label><p id="rev_specialty">-</p></div>
                        <div><label>License No</label><p id="rev_license">-</p></div>
                        <div><label>Experience</label><p id="rev_exp">-</p></div>
                        <div><label>Current Hospital</label><p id="rev_hospital">-</p></div>
                    </div>
                </div>

                <!-- Terms -->
                <div class="terms-box">
                    <h3 class="terms-title">I agree to the Terms & Conditions</h3>
                    <p class="terms-text">I certify that all information provided is accurate and true. I understand that my application will be reviewed by DocPlus administrators.</p>
                </div>
            </div>

            <!-- BUTTONS -->
            <div class="form-actions">
                <button type="button" id="prevBtn" class="btn btn-secondary" onclick="nextPrev(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button type="button" id="nextBtn" class="btn btn-primary" onclick="nextPrev(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>

        </form>
    </div>
</div>

{% block extra_js %}
<script>
    var currentTab = 0; // Current tab is set to be the first tab (0)
    showTab(currentTab); // Display the current tab

    function showTab(n) {
        var x = document.getElementsByClassName("form-step");
        
        // Hide all steps first
        for(let i=0; i<x.length; i++) {
            x[i].style.display = "none";
            x[i].classList.remove('active');
        }
        
        // Show current step
        x[n].style.display = "block";
        setTimeout(() => x[n].classList.add('active'), 10); // Slight delay for fade-in

        // Handle Buttons
        if (n == 0) {
            document.getElementById("prevBtn").style.display = "none";
        } else {
            document.getElementById("prevBtn").style.display = "inline-flex";
        }

        if (n == (x.length - 1)) {
            document.getElementById("nextBtn").innerHTML = '<i class="fas fa-check-circle"></i> Submit Application';
        } else {
            document.getElementById("nextBtn").innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
        }

        updateStepper(n);
        
        // If on Review Step, Populate Data
        if(n == 4) {
            populateReview();
        }
    }

    function nextPrev(n) {
        var x = document.getElementsByClassName("form-step");
        
        // Validate if pressing Next
        if (n == 1 && !validateForm()) return false;
        
        // If submitting (on last step)
        if (currentTab + n >= x.length) {
            document.getElementById("regForm").submit();
            return false;
        }
        
        currentTab = currentTab + n;
        showTab(currentTab);
    }

    function validateForm() {
        var x, y, i, valid = true;
        x = document.getElementsByClassName("form-step");
        y = x[currentTab].getElementsByTagName("input");
        z = x[currentTab].getElementsByTagName("select");
        
        // Check inputs
        for (i = 0; i < y.length; i++) {
            if (y[i].hasAttribute('required') && y[i].value == "") {
                y[i].className += " invalid";
                valid = false;
            }
        }
        // Check selects
        for (i = 0; i < z.length; i++) {
            if (z[i].hasAttribute('required') && z[i].value == "") {
                z[i].className += " invalid";
                valid = false;
            }
        }
        return valid; 
    }

    function updateStepper(n) {
        var steps = document.getElementsByClassName("step");
        var lines = document.getElementsByClassName("line");
        
        // Icons array matching the HTML
        const icons = [
            '<i class="far fa-user"></i>',
            '<i class="fas fa-stethoscope"></i>',
            '<i class="fas fa-graduation-cap"></i>',
            '<i class="far fa-file-alt"></i>',
            '<i class="far fa-check-circle"></i>'
        ];

        for (var i = 0; i < steps.length; i++) {
            let circle = steps[i].querySelector('.circle');
            
            // RESET to default
            steps[i].classList.remove("active", "completed");
            circle.innerHTML = icons[i]; // Restore original icon
            if(i < lines.length) lines[i].classList.remove("completed");

            // ACTIVE Step
            if (i == n) {
                steps[i].classList.add("active");
            }
            // COMPLETED Step
            else if (i < n) {
                steps[i].classList.add("completed");
                circle.innerHTML = '<i class="fas fa-check"></i>'; // Change to checkmark
                if(i < lines.length) lines[i].classList.add("completed");
            }
        }
    }

    function updateFileName(input) {
        if(input.files && input.files[0]) {
            // Find the sibling span to display name
            input.parentElement.querySelector('.file-name').innerText = input.files[0].name;
            // Change button style to indicate success
            let btn = input.parentElement.querySelector('.btn-upload');
            btn.innerHTML = '<i class="fas fa-check"></i> Selected';
            btn.style.background = '#10B981';
            btn.style.color = 'white';
            btn.style.border = 'none';
        }
    }

    function populateReview() {
        // Simple mapping of ID -> Review ID
        document.getElementById('rev_name').innerText = document.getElementById('full_name').value || '-';
        document.getElementById('rev_email').innerText = document.getElementById('email').value || '-';
        document.getElementById('rev_phone').innerText = document.getElementById('phone').value || '-';
        document.getElementById('rev_city').innerText = document.getElementById('city').value || '-';
        
        document.getElementById('rev_specialty').innerText = document.getElementById('specialty').value || '-';
        document.getElementById('rev_license').innerText = document.getElementById('license_no').value || '-';
        document.getElementById('rev_exp').innerText = document.getElementById('experience').value + ' Years' || '-';
        document.getElementById('rev_hospital').innerText = document.getElementById('hospital').value || '-';
    }
</script>
{% endblock %}
{% endblock %}